<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>KarLive - å‰µä½œ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <main class="create-page">
        <h1 class="create-title">å‰µä½œä¸­å¿ƒ</h1>

        <!-- ç™»å…¥ç‹€æ…‹é¡¯ç¤º -->
        <div class="auth-box">
            <div>
                ç›®å‰ç‹€æ…‹ï¼š<span id="authStatus">æª¢æŸ¥ä¸­...</span>
            </div>
            <div class="auth-buttons">
                <a href="login.html" class="btn-link" id="goLoginBtn">å‰å¾€ç™»å…¥ / è¨»å†Š</a>
            </div>
        </div>

        <!-- æœªç™»å…¥é®ç½© -->
        <div id="needLoginMask" class="need-login-mask" style="display:none;">
            <p>è«‹å…ˆç™»å…¥å¾Œæ‰èƒ½ä½¿ç”¨å‰µä½œåŠŸèƒ½</p>
            <a href="login.html">å‰å¾€ç™»å…¥é </a>
        </div>

        <!-- ä¸Šå‚³å€ï¼šé€™ä¸€è¡Œæ˜¯éš±è—çš„æª”æ¡ˆé¸æ“‡ -->
        <input type="file" id="videoFile" accept="video/*" style="display: none">

        <div class="create-card-list">

            <!-- é»é€™å¼µå¡ç‰‡ -> å«å‡ºæª”æ¡ˆé¸æ“‡ä¸¦ä¸Šå‚³ -->
            <div class="create-card" id="uploadCard">
                <div class="create-icon">ğŸ¥</div>
                <div class="create-text">
                    <span>ä¸Šå‚³å½±ç‰‡</span>
                    <small id="uploadStatus">é¸å–ä¸¦ä¸Šå‚³ä½ çš„å½±ç‰‡</small>
                </div>
            </div>

            <div class="create-card">
                <div class="create-icon">ğŸ”´</div>
                <div class="create-text">
                    <span>é–‹å•Ÿç›´æ’­</span>
                    <small>ç«‹å³é–‹å§‹ç›´æ’­</small>
                </div>
            </div>

            <div class="create-card">
                <div class="create-icon">ğŸ–¼</div>
                <div class="create-text">
                    <span>ç™¼ä½ˆè²¼æ–‡</span>
                    <small>åˆ†äº«ä½ çš„ç…§ç‰‡èˆ‡æƒ³æ³•</small>
                </div>
            </div>
        </div>

        <!-- ä¸Šå‚³æˆåŠŸçš„å½±ç‰‡æœƒå‡ºç¾åœ¨é€™è£¡ -->
        <h2 class="section-title" style="margin-top:20px;">æˆ‘ä¸Šå‚³çš„å½±ç‰‡</h2>
        <div id="videoList" class="video-list"></div>

    </main>

    <!-- åº•éƒ¨å°èˆªåˆ—ï¼šè®“ã€Œå‰µä½œã€é«˜äº® -->
    <nav class="bottom-nav">
        <a href="index.html">é¦–é </a>
        <a href="./ç›´æ’­.html">ç›´æ’­</a>
        <a href="./å‰µä½œ.html" class="active">å‰µä½œ</a>
        <a href="./è¨Šæ¯.html">è¨Šæ¯</a>
        <a href="./å€‹äºº.html">å€‹äººä¸­å¿ƒ</a>
    </nav>

    <!-- Firebase + ä¸Šå‚³ + åªé¡¯ç¤ºè‡ªå·±ä¸Šå‚³çš„å½±ç‰‡ -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { 
        getDatabase, ref, set, get, onValue 
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
    import {
        getAuth,
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // âš  é€™è£¡è«‹ã€Œç…§æŠ„ä½  login.html è£¡é‚£ä¸€ä»½ firebaseConfigã€
    const firebaseConfig = {
    apiKey: "AIzaSyAuogis16VOaWE1aP4nO4JH6Dw2elN1VmA",
    authDomain: "karlive-4953d.firebaseapp.com",
    databaseURL: "https://karlive-4953d-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "karlive-4953d",
    storageBucket: "karlive-4953d.firebasestorage.app",
    messagingSenderId: "990353970674",
    appId: "1:990353970674:web:033017250976fb03fb476b",
    measurementId: "G-YEFWX1906F"
  };

    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const auth = getAuth(app);

    const authStatus   = document.getElementById("authStatus");
    const needLoginMask= document.getElementById("needLoginMask");
    const uploadCard   = document.getElementById("uploadCard");
    const uploadStatus = document.getElementById("uploadStatus");
    const fileInput    = document.getElementById("videoFile");
    const videoList    = document.getElementById("videoList");
    const goLoginBtn   = document.getElementById("goLoginBtn");

    let currentUser = null;

    // -----------------------
    // ç›£è½ç™»å…¥ç‹€æ…‹ï¼šæœªç™»å…¥ -> è“‹é®ç½©ï¼›å·²ç™»å…¥ -> é¡¯ç¤ºè‡ªå·±ä¸Šå‚³çš„å½±ç‰‡
    // -----------------------
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            currentUser = null;
            authStatus.textContent = "æœªç™»å…¥ï¼ˆéŠå®¢æ¨¡å¼ï¼‰";
            needLoginMask.style.display = "flex";
            videoList.innerHTML = "";
            if (goLoginBtn) goLoginBtn.style.display = "inline-block";
            return;
        }

        currentUser = user;
        authStatus.textContent = `å·²ç™»å…¥ï¼š${user.email}`;
        needLoginMask.style.display = "none";
        if (goLoginBtn) goLoginBtn.style.display = "none";

        await loadMyVideos();
    });

    // -----------------------
    // é»ã€Œä¸Šå‚³å½±ç‰‡ã€å¡ç‰‡ -> è§¸ç™¼æª”æ¡ˆé¸æ“‡
    // -----------------------
    uploadCard.addEventListener("click", () => {
        if (!currentUser) {
            alert("è«‹å…ˆç™»å…¥å¾Œå†ä¸Šå‚³å½±ç‰‡");
            return;
        }
        fileInput.click();
    });

    // -----------------------
    // æª”æ¡ˆé¸æ“‡å¾Œï¼Œä¸Šå‚³åˆ°å¾Œç«¯ + å­˜é€² Firebase
    // -----------------------
    fileInput.addEventListener("change", async () => {
    const file = fileInput.files[0];
    if (!file) return;

    if (!currentUser) {
        alert("è«‹å…ˆç™»å…¥å¾Œå†ä¸Šå‚³å½±ç‰‡");
        fileInput.value = "";
        return;
    }

    uploadStatus.textContent = "ä¸Šå‚³ä¸­â€¦";

    const formData = new FormData();
    formData.append("video", file);

    try {
        // âœ… æŠŠé€™è£¡æ›æˆä½ çš„ Render External URL
        const res = await fetch("https://karlive.onrender.com/api/upload", {
            method: "POST",
            body: formData,
        });

        if (!res.ok) {
            const text = await res.text();
            console.error("Upload failed, status:", res.status, text);
            alert("ä¸Šå‚³å¤±æ•—ï¼ˆç‹€æ…‹ç¢¼ " + res.status + "ï¼‰ï¼Œè©³ç´°è«‹çœ‹ Consoleã€‚");
            uploadStatus.textContent = "ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            return;
        }

        const data = await res.json();
        console.log("Upload response:", data);

        const videoId = data.videoId;
        const url     = data.url;

        // å­˜åˆ° Firebaseï¼ˆå½±ç‰‡è³‡æ–™ï¼‰
        await set(ref(db, "videos/" + videoId), {
            url,
            createdAt: Date.now(),
            ownerUid: currentUser.uid,
            ownerEmail: currentUser.email
        });

        // åå‘ç´¢å¼•ï¼šé€™å€‹ user ä¸Šå‚³äº†å“ªäº›å½±ç‰‡
        await set(ref(db, "userVideos/" + currentUser.uid + "/" + videoId), true);

        // åˆå§‹åŒ–è®šæ•¸
        await set(ref(db, "likes/" + videoId), 0);

        uploadStatus.textContent = "ä¸Šå‚³å®Œæˆï¼";

        // ç›´æ¥åœ¨ç•«é¢ä¸ŠåŠ ä¸€å¼µå¡ç‰‡
        renderVideoCard(videoId, {
            url,
            createdAt: Date.now(),
            ownerEmail: currentUser.email
        });

        fileInput.value = "";
    } catch (err) {
        console.error("Upload error:", err);
        alert("ä¸Šå‚³éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼ˆè«‹é–‹ F12 çœ‹ Console è©³ç´°è¨Šæ¯ï¼‰");
        uploadStatus.textContent = "ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
    }
});

    // -----------------------
    // è¼‰å…¥ã€Œæˆ‘ä¸Šå‚³çš„å½±ç‰‡ã€
    // -----------------------
    async function loadMyVideos() {
        if (!currentUser) return;

        videoList.innerHTML = "è¼‰å…¥ä¸­â€¦";

        const userVideosRef  = ref(db, "userVideos/" + currentUser.uid);
        const snapUserVideos = await get(userVideosRef);

        if (!snapUserVideos.exists()) {
            videoList.innerHTML = "ä½ ç›®å‰é‚„æ²’æœ‰ä¸Šå‚³å½±ç‰‡ã€‚";
            return;
        }

        const videoIds = Object.keys(snapUserVideos.val());

        videoList.innerHTML = "";
        for (const videoId of videoIds) {
            const videoRef  = ref(db, "videos/" + videoId);
            const snapVideo = await get(videoRef);
            if (!snapVideo.exists()) continue;

            const info = snapVideo.val();
            renderVideoCard(videoId, info);
        }

        if (videoIds.length === 0) {
            videoList.innerHTML = "ä½ ç›®å‰é‚„æ²’æœ‰ä¸Šå‚³å½±ç‰‡ã€‚";
        }
    }

    // -----------------------
    // åœ¨é é¢ä¸Šç•«å‡ºä¸€å€‹å½±ç‰‡å¡ç‰‡
    // -----------------------
    function renderVideoCard(videoId, info) {
        const card = document.createElement("div");
        card.className = "video-card";

        const created = info.createdAt
            ? new Date(info.createdAt).toLocaleString()
            : "";

        card.innerHTML = `
            <video src="${info.url}" controls class="video-player"></video>
            <div class="video-like">
                <div class="video-meta">
                    ä¸Šå‚³æ™‚é–“ï¼š${created}<br>
                    ä¸Šå‚³è€…ï¼š${info.ownerEmail || "ä¸æ˜"}
                </div>
                <div class="icon-block" onclick="toggleLike('${videoId}')">
                    <div class="label">é»è®š</div>
                    <div class="value" id="likeCount_${videoId}">0</div>
                </div>
            </div>
        `;
        videoList.prepend(card);

        setupLike(videoId);
    }

    // -----------------------
    // é»è®šåŒæ­¥ï¼ˆè·Ÿé¦–é é‚è¼¯ä¸€æ¨£ï¼‰
    // -----------------------
    function setupLike(videoId) {
        const likeRef = ref(db, "likes/" + videoId);
        const el = document.getElementById("likeCount_" + videoId);

        onValue(likeRef, snapshot => {
            el.innerText = snapshot.val() ?? 0;
        });
    }

    // é»è®šï¼šæœªç™»å…¥ä¸çµ¦é»
    window.toggleLike = function(videoId) {
        if (!currentUser) {
            alert("è«‹å…ˆç™»å…¥æ‰èƒ½é»è®š");
            return;
        }

        const likeRef = ref(db, "likes/" + videoId);
        const el = document.getElementById("likeCount_" + videoId);
        const now   = Number(el.innerText) || 0;
        const key   = "liked_" + videoId;
        const liked = localStorage.getItem(key) === "true";

        if (liked) {
            set(likeRef, now - 1);
            localStorage.setItem(key, "false");
        } else {
            set(likeRef, now + 1);
            localStorage.setItem(key, "true");
        }
    };
    </script>
</body>
</html>
