<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>KarLive - å€‹äººä¸­å¿ƒ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- ä¸Šæ–¹ç‹€æ…‹åˆ—ï¼šéŠå®¢æ¨¡å¼ / å·²ç™»å…¥ + ç™»å…¥/ç™»å‡º -->
    <div class="user-status-box">
        ç‹€æ…‹ï¼š<span id="userStatus">è®€å–ä¸­...</span>
        <a href="login.html" id="loginBtn">ç™»å…¥</a>
        <button id="logoutBtn" style="display:none;">ç™»å‡º</button>
    </div>

    <main class="profile-page">
        <h1 class="create-title">å€‹äººä¸­å¿ƒ</h1>

        <!-- ä½¿ç”¨è€…è³‡è¨Šå€ -->
        <div class="auth-status-box">
            <div>ç›®å‰ç‹€æ…‹ï¼š<span id="authStatus">æœªç™»å…¥</span></div>
        </div>

        <h2 class="section-title" style="margin-top:20px;">æˆ‘ä¸Šå‚³çš„å½±ç‰‡</h2>
        <div id="myVideoList" class="video-list"></div>
    </main>

    <!-- åº•éƒ¨å°èˆªåˆ— -->
    <nav class="bottom-nav">
        <a href="index.html">é¦–é </a>
        <a href="./ç›´æ’­.html">ç›´æ’­</a>
        <a href="./å‰µä½œ.html">å‰µä½œ</a>
        <a href="./è¨Šæ¯.html">è¨Šæ¯</a>
        <a href="./å€‹äºº.html" class="active">å€‹äººä¸­å¿ƒ</a>
    </nav>

    <!-- â­ å”¯ä¸€çš„ä¸€å€‹ scriptï¼Œæ‰€æœ‰ Firebase / Auth / Database éƒ½åœ¨é€™è£¡ â­ -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { 
        getAuth,
        onAuthStateChanged,
        signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { 
        getDatabase, ref, onValue, set, get 
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    // ğŸ”¥ Firebase è¨­å®šï¼ˆè·Ÿå…¶ä»–é ä¸€æ¨£ï¼‰
    const firebaseConfig = {
    apiKey: "AIzaSyAuogis16VOaWE1aP4nO4JH6Dw2elN1VmA",
    authDomain: "karlive-4953d.firebaseapp.com",
    databaseURL: "https://karlive-4953d-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "karlive-4953d",
    storageBucket: "karlive-4953d.firebasestorage.app",
    messagingSenderId: "990353970674",
    appId: "1:990353970674:web:033017250976fb03fb476b",
    measurementId: "G-YEFWX1906F"
  };
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    let currentUser = null;


    // DOM å…ƒç´ 
    const statusEl    = document.getElementById("userStatus");
    const loginBtn    = document.getElementById("loginBtn");
    const logoutBtn   = document.getElementById("logoutBtn");
    const authStatus  = document.getElementById("authStatus");
    const myVideoList = document.getElementById("myVideoList");

    // -----------------------
    // ç›£è½ç™»å…¥ç‹€æ…‹ï¼ˆåŒæ™‚æ›´æ–°ä¸Šæ–¹ç‹€æ…‹åˆ— ï¼‹ ä¸‹æ–¹ã€Œæˆ‘ä¸Šå‚³çš„å½±ç‰‡ã€ï¼‰
    // -----------------------
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            // ğŸ”¹ æœªç™»å…¥ / éŠå®¢æ¨¡å¼
            currentUser = null;

            statusEl.innerText    = "éŠå®¢æ¨¡å¼";
            authStatus.textContent = "æœªç™»å…¥";

            loginBtn.style.display  = "inline-block";
            logoutBtn.style.display = "none";

            myVideoList.innerHTML = "";
            return;
        }

        // ğŸ”¹ å·²ç™»å…¥
        currentUser = user;

        statusEl.innerText      = "å·²ç™»å…¥ï¼š" + user.email;
        authStatus.textContent  = `å·²ç™»å…¥ï¼š${user.email}`;
        profileHint.textContent = "ä»¥ä¸‹æ˜¯ä½ ä¸Šå‚³çš„å½±ç‰‡ï¼š";

        loginBtn.style.display  = "none";
        logoutBtn.style.display = "inline-block";

        await loadMyVideos(user.uid);
    });

    // â­ é»ç™»å‡ºæŒ‰éˆ•
    logoutBtn.addEventListener("click", () => {
        signOut(auth);
    });

    // -----------------------
    // é¡¯ç¤ºå½±ç‰‡å¡ç‰‡
    // -----------------------
    function renderMyVideoCard(videoId, info) {
        const card = document.createElement("div");
        card.className = "video-card";
        const created = info.createdAt 
            ? new Date(info.createdAt).toLocaleString()
            : "";

        card.innerHTML = `
            <video src="${info.url}" controls class="video-player"></video>
            <div class="video-like">
                <div class="video-meta">ä¸Šå‚³æ™‚é–“ï¼š${created}</div>
                <div class="icon-block" onclick="toggleLike('${videoId}')">
                    <div class="label">é»è®š</div>
                    <div class="value" id="likeCount_${videoId}">0</div>
                </div>
            </div>
        `;
        myVideoList.appendChild(card);

        setupLike(videoId);
    }

    // -----------------------
    // é»è®šåŒæ­¥ï¼ˆå’Œå…¶ä»–é å…±ç”¨é‚è¼¯ï¼‰
    // -----------------------
    function setupLike(videoId) {
        const likeRef = ref(db, "likes/" + videoId);
        const el = document.getElementById("likeCount_" + videoId);

        onValue(likeRef, snapshot => {
            el.innerText = snapshot.val() ?? 0;
        });
    }

    window.toggleLike = function(videoId) {
        const likeRef = ref(db, "likes/" + videoId);
        const el = document.getElementById("likeCount_" + videoId);
        const now   = Number(el.innerText);
        const key   = "liked_" + videoId;
        const liked = localStorage.getItem(key) === "true";

        if (liked) {
            set(likeRef, now - 1);
            localStorage.setItem(key, "false");
        } else {
            set(likeRef, now + 1);
            localStorage.setItem(key, "true");
        }
    };

    // -----------------------
    // è®€å–ã€Œæˆ‘ä¸Šå‚³çš„å½±ç‰‡ã€
    // -----------------------
    async function loadMyVideos(uid) {
        myVideoList.innerHTML = "è¼‰å…¥ä¸­â€¦";

        // ç”¨ userVideos/uid å¿«é€Ÿæ‰¾åˆ°è‡ªå·±çš„å½±ç‰‡ ID
        const userVideosRef   = ref(db, "userVideos/" + uid);
        const snapUserVideos  = await get(userVideosRef);

        if (!snapUserVideos.exists()) {
            myVideoList.innerHTML = "ä½ ç›®å‰é‚„æ²’æœ‰ä¸Šå‚³å½±ç‰‡ã€‚";
            return;
        }

        const videoIds = Object.keys(snapUserVideos.val());

        myVideoList.innerHTML = "";
        for (const videoId of videoIds) {
            const videoRef  = ref(db, "videos/" + videoId);
            const snapVideo = await get(videoRef);
            if (!snapVideo.exists()) continue;

            const info = snapVideo.val();
            renderMyVideoCard(videoId, info);
        }

        if (videoIds.length === 0) {
            myVideoList.innerHTML = "ä½ ç›®å‰é‚„æ²’æœ‰ä¸Šå‚³å½±ç‰‡ã€‚";
        }
    }
    </script>
</body>
</html>
