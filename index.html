<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>KarLive - é¦–é </title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>
<body>

    <!-- â­ ä½¿ç”¨è€…ç‹€æ…‹åˆ— -->
    <div class="user-status-box">
        ç‹€æ…‹ï¼š<span id="homeStatus">è®€å–ä¸­...</span>
        <a href="login.html" id="homeLoginBtn">ç™»å…¥</a>
        <button id="homeLogoutBtn" style="display:none;">ç™»å‡º</button>
    </div>

    <!-- å³å´åŠŸèƒ½ç›´æ’ -->
    <div class="right-panel">
        <div class="avatar">é ­åƒ</div>

        <!-- ä¸»é»è®šæŒ‰éˆ•ï¼ˆé€™æ”¯å½±ç‰‡çš„è®šæ•¸ï¼‰ -->
        <div class="icon-block like-block" onclick="toggleRightLike()">
            <div class="label">é»è®š</div>
            <div class="value" id="rightLikeCount">0</div>
        </div>

        <!-- æ”¶è— -->
        <div class="icon-block fav-btn" onclick="toggleFavorite()">
            <div class="label">æ”¶è—</div>
            <div class="value" id="favoriteState">0</div>
        </div>

        <!-- è©•è«–ï¼ˆä¹‹å¾Œå¯ä»¥åšæˆæ‰“é–‹ç•™è¨€è¦–çª—ï¼‰ -->
        <div class="icon-block comment-btn" onclick="openComment()">
            <div class="label">è©•è«–</div>
            <div class="value" id="commentCount">0</div>
        </div>

        <!-- é—œæ³¨ä½œè€… -->
        <div class="icon-block follow-btn" onclick="followAuthor()">
            <div class="label">é—œæ³¨ä½œè€…</div>
        </div>
    </div>

    <!-- ä¸»å…§å®¹ï¼ˆå¤§å½±ç‰‡ï¼‰ -->
    <div class="main-content">
        <h1><a href="">|||</a></h1>

        <div class="main-video-container">
            <video id="mainVideo" class="main-video-player" autoplay muted loop controls></video>
        </div>
    </div>

    <!-- åº•éƒ¨å°èˆªåˆ— -->
    <nav class="bottom-nav">
        <a href="index.html" class="active">é¦–é </a>
        <a href="./ç›´æ’­.html">ç›´æ’­</a>
        <a href="./å‰µä½œ.html">å‰µä½œ</a>
        <a href="./è¨Šæ¯.html">è¨Šæ¯</a>
        <a href="./å€‹äºº.html">å€‹äººä¸­å¿ƒ</a>
    </nav>

    <!-- Firebase + é¦–é é‚è¼¯ -->
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { 
        getDatabase, ref, onValue, set, get 
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";
    import {
        getAuth,
        onAuthStateChanged,
        signOut
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // ğŸ”¥ è·Ÿå…¶ä»–é ä¸€æ¨£çš„ Firebase è¨­å®š
    const firebaseConfig = {
    apiKey: "AIzaSyAuogis16VOaWE1aP4nO4JH6Dw2elN1VmA",
    authDomain: "karlive-4953d.firebaseapp.com",
    databaseURL: "https://karlive-4953d-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "karlive-4953d",
    storageBucket: "karlive-4953d.firebasestorage.app",
    messagingSenderId: "990353970674",
    appId: "1:990353970674:web:033017250976fb03fb476b",
    measurementId: "G-YEFWX1906F"
  };

    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const auth = getAuth(app);

    // DOM åƒè€ƒ
    const homeStatus    = document.getElementById("homeStatus");
    const homeLoginBtn  = document.getElementById("homeLoginBtn");
    const homeLogoutBtn = document.getElementById("homeLogoutBtn");

    const mainVideo       = document.getElementById("mainVideo");
    const rightLikeCount  = document.getElementById("rightLikeCount");
    const favoriteState   = document.getElementById("favoriteState");


    let currentUser     = null;   // ç›®å‰ç™»å…¥ä½¿ç”¨è€…ï¼ˆnull = éŠå®¢ï¼‰
    let currentVideoId  = null; // ç›®å‰é¦–é ä¸»å½±ç‰‡çš„ ID
        // ä¾ç…§ç›®å‰ä½¿ç”¨è€… + ç›®å‰å½±ç‰‡ï¼Œæ›´æ–°å³é‚Šæ”¶è—æ–‡å­—
    async function updateFavoriteState() {
        if (!favoriteState) return;

        // æ²’ç™»å…¥æˆ–æ²’æœ‰é¸åˆ°å½±ç‰‡ï¼Œå°±é¡¯ç¤ºã€Œæœªæ”¶è—ã€
        if (!currentUser || !currentVideoId) {
            favoriteState.innerText = "æœªæ”¶è—";
            return;
        }

        const favRef = ref(db, "favorites/" + currentUser.uid + "/" + currentVideoId);
        const snap = await get(favRef);
        const isFav = !!snap.val();

        favoriteState.innerText = isFav ? "å·²æ”¶è—" : "æœªæ”¶è—";
    }
    let currentOwnerUid = null;   // é€™æ”¯å½±ç‰‡çš„ä½œè€… UIDï¼ˆå¦‚æœæœ‰ï¼‰

    // -----------------------
    // ç›£è½ç™»å…¥ç‹€æ…‹ï¼ˆéŠå®¢ / å·²ç™»å…¥ï¼‰
    // -----------------------
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            homeStatus.textContent = `å·²ç™»å…¥ï¼š${user.email}`;
            updateFavoriteState();

            homeLoginBtn.style.display  = "none";
            homeLogoutBtn.style.display = "inline-block";
        } else {
            currentUser = null;
            homeStatus.textContent = "éŠå®¢æ¨¡å¼";
            updateFavoriteState();

            homeLoginBtn.style.display  = "inline-block";
            homeLogoutBtn.style.display = "none";
        }
    });

    // ç™»å‡º
    homeLogoutBtn.addEventListener("click", () => {
        signOut(auth);
    });

    // -----------------------
    // è¼‰å…¥é¦–é ä¸»å½±ç‰‡ï¼ˆæœ€æ–°ä¸€æ”¯ï¼‰
    // -----------------------
    async function loadMainVideo() {
        const videosRef = ref(db, "videos");
        const snapshot  = await get(videosRef);
        if (!snapshot.exists()) {
            // é‚„æ²’æœ‰å½±ç‰‡
            mainVideo.removeAttribute("src");
            return;
        }

        const data = snapshot.val();
        const entries = Object.entries(data)
            .sort(([, a], [, b]) => (b.createdAt || 0) - (a.createdAt || 0));

        const [videoId, info] = entries[0];
        currentVideoId  = videoId;
        currentOwnerUid = info.ownerUid || null;

        mainVideo.src = info.url;
        bindRightLikes(videoId);
        updateFavoriteState();
    }

    function bindRightLikes(videoId) {
        const likeRef = ref(db, "likes/" + videoId);
        onValue(likeRef, snapshot => {
            const val = snapshot.val() ?? 0;
            rightLikeCount.innerText = val;
        });
    }

    // -----------------------
    // é»è®š / æ”¶è— / è©•è«– / é—œæ³¨ï¼šéŠå®¢è¦æ“‹æ‰
    // -----------------------

    // å³å´ä¸»ã€Œé»è®šã€æŒ‰éˆ•
    window.toggleRightLike = function () {
        if (!currentVideoId) return;
        toggleLike(currentVideoId);
    };

    // å…±ç”¨é»è®šé‚è¼¯ï¼ˆå¦‚æœæœªä¾†æœ‰å°å¡ç‰‡ä¹Ÿå¯ä»¥ç”¨é€™æ”¯ï¼‰
    window.toggleLike = function (videoId) {
        if (!currentUser) {
            alert("è«‹å…ˆç™»å…¥æ‰èƒ½é»è®š");
            return;
        }
        const likeRef = ref(db, "likes/" + videoId);
        const el = (videoId === currentVideoId)
            ? rightLikeCount
            : document.getElementById("likeCount_" + videoId);

        const now   = Number(el?.innerText || 0);
        const key   = "liked_" + videoId + "_" + currentUser.uid;
        const liked = localStorage.getItem(key) === "true";

        if (liked) {
            set(likeRef, now - 1);
            localStorage.setItem(key, "false");
        } else {
            set(likeRef, now + 1);
            localStorage.setItem(key, "true");
        }
    };

    // æ”¶è—ï¼ˆç¤ºæ„ï¼šå…ˆç”¨ alertï¼Œä¸çœŸçš„å¯«å…¥ DBï¼›ä¹‹å¾Œä½ è¦æˆ‘å¯ä»¥å¹«ä½ åš favorites çµæ§‹ï¼‰
    window.toggleFavorite = async function () {
        if (!currentUser) {
            alert("è«‹å…ˆç™»å…¥æ‰èƒ½æ”¶è—");
            return;
        }
        if (!currentVideoId) return;
const favRef = ref(db, "favorites/" + currentUser.uid + "/" + currentVideoId);

        // å…ˆæŸ¥ç¾åœ¨æ˜¯ä¸æ˜¯å·²æ”¶è—
        const snap = await get(favRef);
        const isFav = !!snap.val();

        // åˆ‡æ› true / false
        await set(favRef, !isFav);

        // æ›´æ–°å³é‚Šçš„æ–‡å­—
        favoriteState.innerText = !isFav ? "å·²æ”¶è—" : "æœªæ”¶è—";
    };

    // è©•è«–ï¼ˆç¤ºæ„ï¼‰
    window.openComment = function () {
        if (!currentUser) {
            alert("è«‹å…ˆç™»å…¥æ‰èƒ½ç•™è¨€");
            return;
        }
        if (!currentVideoId) return;

        alert("ï¼ˆç¤ºæ„ï¼‰é€™è£¡å¯ä»¥é–‹å•Ÿç•™è¨€è¼¸å…¥æ¡†ï¼Œå¯«å…¥ comments/" 
              + currentVideoId);
    };

    // é—œæ³¨ä½œè€…
    window.followAuthor = async function () {
        if (!currentUser) {
            alert("è«‹å…ˆç™»å…¥æ‰èƒ½é—œæ³¨ä½œè€…");
            return;
        }
        if (!currentVideoId) return;

        // å¦‚æœæ²’æœ‰é å…ˆè¨˜éŒ„ ownerUidï¼Œå°±å» DB å†æŸ¥ä¸€æ¬¡
        let ownerUid = currentOwnerUid;
        if (!ownerUid) {
            const videoRef = ref(db, "videos/" + currentVideoId);
            const snap = await get(videoRef);
            if (!snap.exists()) {
                alert("æ‰¾ä¸åˆ°å½±ç‰‡è³‡æ–™");
                return;
            }
            const info = snap.val();
            ownerUid = info.ownerUid;
        }

        if (!ownerUid) {
            alert("é€™æ”¯å½±ç‰‡å°šç„¡ä½œè€…è³‡è¨Šï¼ˆä¸Šå‚³æ™‚æ²’å¯« ownerUidï¼‰");
            return;
        }

        // å¯«å…¥é—œæ³¨é—œä¿‚ï¼šfollows/è‡ªå·±uid/ä½œè€…uid = true
        const followRef = ref(db, "follows/" + currentUser.uid + "/" + ownerUid);
        await set(followRef, true);
        alert("å·²é—œæ³¨ä½œè€…");
    };

    // é é¢è¼‰å…¥æ™‚è¼‰å…¥ä¸»å½±ç‰‡
    window.addEventListener("load", loadMainVideo);
    </script>
</body>
</html>

